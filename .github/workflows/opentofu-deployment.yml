name: OpenTofu Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

permissions:
  contents: read
  pull-requests: write
  id-token: write
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

env:
  # Service Principal Client IDs (from 2_platform_identity outputs)
  SP_PLATFORM_MANAGEMENT_CLIENT_ID: "" # TODO: Add after applying 2_platform_identity

jobs:
  # Jobs in reverse order of dependency; then its in right order in the gh actions UI

  # ===== Platform Management (dev) =====
  # Lint, plan and apply for platform management
  pl-management-dev-lint:
    name: pl-management-dev lint
    uses: ./.github/workflows/opentofu-lint.yml
    with:
      working_directory: ./1_platform_management/environments/dev

  pl-management-dev-plan:
    name: pl-management-dev plan
    needs: [pl-management-dev-lint]
    uses: ./.github/workflows/opentofu-plan.yml
    with:
      working_directory: ./1_platform_management/environments/dev
      artifact_name: pl-management-dev
      state_key: pl-management-dev.tfstate
      client_id: ${{ env.SP_PLATFORM_MANAGEMENT_CLIENT_ID }}

  pl-management-dev-apply:
    name: pl-management-dev apply
    needs: [pl-management-dev-plan]
    uses: ./.github/workflows/opentofu-apply.yml
    with:
      working_directory: ./1_platform_management/environments/dev
      artifact_name: pl-management-dev
      state_key: pl-management-dev.tfstate
      client_id: ${{ env.SP_PLATFORM_MANAGEMENT_CLIENT_ID }}

  # ===== Platform Identity (dev) =====
  # Lint, plan and apply for platform identity
  pl-identity-dev-lint:
    name: pl-identity-dev lint
    uses: ./.github/workflows/opentofu-lint.yml
    with:
      working_directory: ./2_platform_identity/environments/dev

  pl-identity-dev-plan:
    name: pl-identity-dev plan
    needs: [pl-identity-dev-lint]
    uses: ./.github/workflows/opentofu-plan.yml
    with:
      working_directory: ./2_platform_identity/environments/dev
      artifact_name: pl-identity-dev
      state_key: pl-identity-dev.tfstate

  pl-identity-dev-apply:
    name: pl-identity-dev apply
    needs: [pl-identity-dev-plan]
    uses: ./.github/workflows/opentofu-apply.yml
    with:
      working_directory: ./2_platform_identity/environments/dev
      artifact_name: pl-identity-dev
      state_key: pl-identity-dev.tfstate

  # ===== ALZ Drives (dev) =====
  # Lint, plan and apply for ALZ drives (storage)
  alz-drive-dev-lint:
    name: alz-drive-dev lint
    uses: ./.github/workflows/opentofu-lint.yml
    with:
      working_directory: ./3_alz_drives/environments/dev

  alz-drive-dev-plan:
    name: alz-drive-dev plan
    needs: [alz-drive-dev-lint]
    uses: ./.github/workflows/opentofu-plan.yml
    with:
      working_directory: ./3_alz_drives/environments/dev
      artifact_name: alz-drive-dev
      state_key: alz-drive-dev.tfstate
    secrets: inherit

  alz-drive-dev-apply:
    name: alz-drive-dev apply
    needs: [alz-drive-dev-plan]
    uses: ./.github/workflows/opentofu-apply.yml
    with:
      working_directory: ./3_alz_drives/environments/dev
      artifact_name: alz-drive-dev
      state_key: alz-drive-dev.tfstate
    secrets: inherit
